---
name: discord-context-search
description: Discordエクスポートデータからキーワード検索し、文脈を抽出・分析・要約してファイル保存するスキル。
user_invocable: true
---

# Discord Context Search — キーワード文脈抽出・分析スキル

Discordのエクスポート済みCSVデータからキーワードを検索し、関連する会話の文脈を抽出、分析、要約して専用フォルダにファイルとして保存する。

## 引数

```
/discord-context-search <キーワード>
/discord-context-search <キーワード> --exports-dir <パス>
```

- **キーワード**（必須）: 検索する単語。メッセージ内容・送信者名・チャンネル名を対象に検索する
- **--exports-dir**（省略可）: エクスポートデータの格納ディレクトリ。省略時はカレントディレクトリ以下を自動検索

## 実行手順

**このスキルは全自動で実行する。ユーザーへの確認は不要。**

### Phase 1: データ抽出（Pythonスクリプト実行）

1. `Bash` で以下のコマンドを実行する:

```bash
python3 ~/.claude/skills/discord-context-search/extract_context.py "<キーワード>" --exports-dir "<exports_dirのパス>"
```

- `--exports-dir` はユーザー指定があればそのパス、なければ省略（自動検索）
- スクリプトが `conversation.csv` と `metadata.json` を出力する
- 出力先は `<exports_dir>/keyword_search/<キーワード>/`

2. スクリプトが正常終了したことを確認する。エラーの場合はユーザーに報告する。

3. **マッチ数が0件の場合（表記ゆれ対応）**: スクリプトの結果が0件の場合、以下のフォールバックを試みる:
   - キーワードがひらがな/カタカナの場合 → ローマ字変換して再検索（例: 「せいりゅう」→「SEIRYU」）
   - キーワードがローマ字の場合 → ひらがな/カタカナ変換して再検索
   - キーワードの一部だけでも `Grep` で `messages.csv` を検索して関連表記を特定する
   - 見つかった表記で再度スクリプトを実行する
   - フォールバックでも見つからない場合は、その旨ユーザーに報告する

### Phase 2: データ読み込み

1. `Read` で出力された `metadata.json` を読み込む
2. `Read` で出力された `conversation.csv` を読み込む（大量の場合は先頭500行）

### Phase 3: 分析・要約生成

読み込んだ会話データを分析し、以下の構造で `summary.md` を生成する:

```markdown
# 「{キーワード}」関連コンテキスト要約

## 検索結果

- **検出元**: {サーバー名} / {チャンネル名}
- **期間**: {日付範囲}
- **関連メッセージ数**: {直接マッチ数}件（文脈含む: {合計抽出数}件）
- **主要な登場人物**: {人名リスト}

## 起こっていること

{このキーワードに関連して、何が起こっているのかを時系列で要約する。
会話の流れから読み取れる事実をベースに記述する。}

## 現在の課題・問題点

{会話から読み取れる未解決の課題、問題点、懸念事項をリストアップする。
明示的に言及されているものと、文脈から推測されるものを分けて記載する。}

### 明示的な課題
- {会話内で直接言及されている課題}

### 潜在的な課題
- {文脈から推測される課題}

## 今後やるべきこと（TODO）

{会話から読み取れる未完了のタスク、今後の予定、必要なアクションをリストアップする。
担当者が分かる場合は併記する。}

- [ ] {タスク1}（担当: {人名 or 不明}）
- [ ] {タスク2}（担当: {人名 or 不明}）

## 要点リスト

{キーワードに関する重要な事実・決定事項を番号付きリストで整理する。}

1. **{要点タイトル1}**
   - {詳細}

2. **{要点タイトル2}**
   - {詳細}

## 関連人物

| 名前 | 役割・文脈 |
|------|-----------|
| {名前} | {この話題における役割や発言の要約} |
```

### Phase 4: ファイル保存

1. `Write` で `summary.md` を出力先ディレクトリに保存する
   - パス: `<exports_dir>/keyword_search/<キーワード>/summary.md`

2. ユーザーに以下を報告する:
   - 検索結果のサマリー（マッチ数、期間、サーバー）
   - 主要な発見事項（3行以内）
   - 保存先ディレクトリのパス

## 注意事項

- **事実ベース**: 会話データに含まれる情報のみをベースに分析する。推測する場合は明示的に「推測」と記載する
- **日本語出力**: すべての出力は日本語で行う
- **0件の場合**: キーワードが見つからなかった場合は、その旨をユーザーに報告して終了する
- **大量データ**: 抽出メッセージが500件を超える場合は、チャンネル別に分割して分析する
- **プライバシー**: 個人の連絡先情報（電話番号、メールアドレス等）は要約に含めない
