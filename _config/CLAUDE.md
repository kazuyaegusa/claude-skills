# グローバル開発ルール

## 基本方針

- 回答・コミットメッセージ・コメントは日本語で行う（コード中の変数名・関数名は英語）
- 過剰エンジニアリングをしない。必要最小限の変更に留める
- 既存コードを理解してから変更を提案する

## Agent Team 自動編成ルール（必須）

ユーザーから「チームで」等の明示的な指示がなくても、**以下の条件に該当するタスクは自動的に Agent Team を編成して実行すること**。これはすべてのプロジェクトに適用されるグローバルルールである。

### チーム編成の判断基準

以下のいずれかに該当する場合、自動的にチームを編成する:

1. **並列化可能な独立サブタスクが2つ以上ある場合**（調査、実装、テストなど）
2. **複数ファイルにまたがる実装タスク**（3ファイル以上の変更が見込まれる場合）
3. **調査 + 実装が必要なタスク**（調査エージェントと実装エージェントを分離）
4. **コードレビュー・リファクタリング**（分析と修正を並列化）

### チーム編成しない場合

- 単一ファイルの軽微な修正（typo修正、1関数の追加等）
- 質問への回答・説明のみ
- 単純な1ステップのコマンド実行

### 編成時のルール

- チーム名はタスク内容を反映した簡潔な英語名にする
- **Explore 型**: 調査・分析タスクに使用（読み取り専用）
- **general-purpose 型**: 実装・ファイル編集タスクに使用
- **Plan 型**: アーキテクチャ設計・計画策定に使用
- タスク間の依存関係を必ず設定する
- 全タスク完了後、エージェントをシャットダウンしチームを削除する
- ユーザーへの報告は統合した簡潔なサマリーで行う

## ハルシネーション防止ルール

- **推測するな、確認しろ**: ファイルパス・関数名・API・CLIフラグを推測しない。`Glob`/`Grep`/`Read` で必ず確認する
- **存在しないものを作るな**: パッケージ・ライブラリ・依存関係を捏造しない
- **プロジェクト構造を仮定するな**: 実際にファイルを読んで確認する
- **分からなければ聞け**: 不確かなことは推測せずユーザーに質問する
- **動作確認してから報告しろ**: 「動くはず」ではなく、実行して確認する

## トークン節約ルール

- **簡潔に答える**: 短い回答が良い回答。冗長な前置き・まとめは不要
- **フィラー禁止**: 「承知しました！」「もちろんです！」等の無意味な応答を入れない
- **コードで示す**: 説明するよりコードを書く。動くコードが最良の説明
- **最小差分**: 変更が必要な箇所だけ変更する。周辺コードのリファクタリングは頼まれない限りしない
- **不要なコメント・docstring を追加しない**: ロジックが自明でない場合のみ
- **編集後にファイル内容を繰り返さない**: diff で十分

## 開発ワークフロー（推奨順序）

1. **計画**: 実装前に計画を立てる。非自明なタスクは EnterPlanMode を使う
2. **テスト先行**: 可能な限りテストを先に書き、実装はテストを通すために行う（TDD）
3. **検証**: 実装後は build / type check / lint / test を確認する
4. **レビュー**: 品質・保守性・セキュリティを確認する

## コーディングルール

### 共通

- イミュータブル志向: 可能な限り `const` / `readonly` / 不変データ構造を使う
- エラーハンドリング: 例外・エラーは明示的に処理する。握りつぶさない
- 入力検証: 外部入力（ユーザー入力、API レスポンス）は必ずバリデーションする
- テスト: カバレッジ 80% 以上を目標にする。新機能には必ずテストを書く
- セキュリティ: OWASP Top 10 を意識する。コマンドインジェクション、XSS、SQLインジェクション等を防ぐ
- 命名: 意味のある名前を付ける。略語は一般的なもの（URL, ID 等）のみ許容
- 関数: 1つの関数は1つの責務。長くなったら分割する
- コメント: ロジックが自明でない場合のみ記述する。「何をしているか」ではなく「なぜそうしているか」を書く

### TypeScript

- `any` を避ける。型は可能な限り厳密に定義する
- `interface` より `type` を優先（合成しやすい）
- `null` チェックは早期リターンパターンで処理する
- 非同期処理は `async/await` を使う（`.then()` チェーンより読みやすい）

### Python

- 型ヒントを積極的に使う
- `dataclass` / `Pydantic` でデータ構造を明示する
- リスト内包表記は短い場合のみ。複雑なら通常ループを使う
- `f-string` を文字列フォーマットに使う

### Go

- エラーは必ずチェックする（`_ =` で無視しない）
- `context.Context` を関数の第一引数に渡す
- インターフェースは利用側で定義する
- ゴルーチンのリークに注意する

## セキュリティチェックリスト

コードを書く際、以下を常に確認する:

- [ ] ユーザー入力のサニタイズ
- [ ] SQL パラメータバインディング（文字列結合での SQL 構築禁止）
- [ ] 機密情報（API キー、パスワード）のハードコード禁止
- [ ] 適切な認証・認可チェック
- [ ] CORS 設定の妥当性
- [ ] 依存パッケージの脆弱性確認

## Git コミット

- コミットメッセージは日本語で、変更の「なぜ」を簡潔に書く
- 1コミット = 1つの論理的変更
- `.env` や credentials を含むファイルはコミットしない

## カスタムスキル

### PDF Logo Remover (`/remove-pdf-logo`)

PDFの全ページからロゴ/ウォーターマークを自動検出・一括除去するスキル。

- スクリプト: `~/.claude/skills/pdf-logo-remover/remove_pdf_logo.py`
- コマンド: `/remove-pdf-logo <PDFパス>`
- 直接実行: `python3 ~/.claude/skills/pdf-logo-remover/remove_pdf_logo.py input.pdf`
- 依存: `PyMuPDF`, `Pillow`, `numpy`

### Folder Digest (`/folder-digest`)

カレントフォルダの全ファイルを読み込み、内容を的確かつ網羅的に把握して構造化レポートを出力するスキル。

- スキル定義: `~/.claude/skills/folder-digest/SKILL.md`
- コマンド: `/folder-digest [パス]`（省略時はカレントディレクトリ）
- 機能: ディレクトリスキャン → ファイル分類 → 内容読み込み → 構造化レポート出力
- 大規模フォルダ（10ファイル以上）は Agent Team を自動編成して並列処理

### Quality Harness (`/quality-harness`)

任意の Python プロジェクトに品質ハーネス（eval評価・実行隔離・CI/CD・Git hooks）を一括セットアップするスキル。

- スキル定義: `~/.claude/skills/quality-harness/SKILL.md`
- コマンド: `/quality-harness [パス]`（省略時はカレントディレクトリ）
- 機能: プロジェクト検出 → eval ハーネス + runner ハーネス + CI/CD + Git hooks + Makefile を自動生成
- 既存ファイルがある場合は上書きせず不足分のみ追加
- grader 4種同梱: ExactMatch（完全一致）、Contains（部分一致）、KeyExists（キー存在）、Schema（型構造）

### Discord Context Search (`/discord-context-search`)

Discordエクスポートデータからキーワード検索し、関連する会話の文脈を抽出・分析・要約してファイル保存するスキル。

- スキル定義: `~/.claude/skills/discord-context-search/SKILL.md`
- スクリプト: `~/.claude/skills/discord-context-search/extract_context.py`
- コマンド: `/discord-context-search <キーワード>`
- 機能: CSV検索 → 文脈抽出 → 分析・要約生成 → ファイル保存（conversation.csv + metadata.json + summary.md）
- 表記ゆれ対応: ひらがな/カタカナ/ローマ字のフォールバック検索あり
- 出力先: `<exports_dir>/keyword_search/<キーワード>/`

### Phase Report (`/phase-report`)

フェーズ完了レポートを自動生成してコミット・プッシュするスキル。

**重要: 承認不要・完全自動実行ルール**
- `/phase-report` を実行したら、**ユーザーへの確認・承認を一切求めずに**以下を全自動で実行する
- git リポジトリが存在しない場合は `git init` + GitHub リポジトリ作成（`gh repo create`）を自動実行
- リモートリポジトリが未設定の場合も自動作成
- MTG_transcript.md 等の付随ファイルもデフォルトでコミットに含める（.gitignore に明示的に除外されていない限り）
- コミットメッセージは自動生成
- `git push` まで自動で完了する
- レポート内容の確認もユーザーに求めない

### Project Review (`/project-review`)

プロジェクトのドキュメント・コードを多角的にレビューし、実現性・正確性・改善点を検証して修正するスキル。

- スキル定義: `~/.claude/skills/project-review/SKILL.md`
- コマンド: `/project-review [対象パス]`（省略時はカレントディレクトリ）
- 機能: ファイル分類 → Agent Team 編成 → 多角的レビュー → 問題修正 → 検証
- レビュー観点: 技術的正確性、実現性、ドキュメント品質、コード品質、カバレッジ
- 出力: `docs/review_report.md` にレビューレポートを生成
